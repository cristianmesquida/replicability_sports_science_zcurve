---
title: "Sensitivity analyses"
format:
  pdf: default
---

```{r}
#| echo: false
#| message: false
#| warning: false

# load packages
library(magrittr)
library(here)
library(readxl)
library(dplyr)
library(kableExtra)
library(zcurve)
```

```{r}
#| echo: false

# load data
zcurve_data <- read_xlsx("../data/zcurve_data.xlsx", sheet = "Sheet1")
```

```{r}
#| echo: false

pvalues <- zcurve_data %>%
  filter(include == "yes" & !is.na(zcurve_pvalue)) %>%
  select(zcurve_pvalue) %>%
  pull() %>%
  as.numeric()
```

## Secondary z-curve analyses

Four sensitivity analyses were conducted to assess the robustness of the results to different analytic decisions.

### Sensitivity analysis 1

We conduct a $z$-curve analysis excluding $p$-values that could be not recomputed when reported as "*p* \< 0.001", "*p* \< 0.005" and "*p* \< 0.003" but were imputed as *p* = 0.0001 and 0.0005 in the primary $z$-curve.

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

sensitivity_1 <- zcurve_data %>%
  # Select studies that were included + no missing cases
  filter(include == "yes" & !is.na(zcurve_pvalue)) %>%
  # Exclude studies for which p-values were imputed
  filter(!reason_exclusion %in% c("p < 0.001", 
                                  "p < 0.005",
                                  "p < 0.003")) %>%
  select(zcurve_pvalue) %>%
  pull() %>%
  as.numeric()

sensitivity_1 <- zcurve(p = sensitivity_1)
plot(sensitivity_1, CI = TRUE, annotation = TRUE, main = NULL)
```

### Sensitivity analysis 2

We conduct a $z$-curve analysis replacing $p$-values reported as $p$ \< 0.05 for $p$ \< 0.025

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

# Select studies that reported p as "p < 0.05" and were not included in the z-curve analysis
s_imprecise_pvalues <- zcurve_data %>%
  filter(include == "no" & pvalue == "p < 0.05") %>%
  select(include, pvalue, zcurve_pvalue)

# Convert "p < 0.05" to 0.25
s_imprecise_pvalues <- s_imprecise_pvalues %>%
  mutate(zcurve_pvalue = case_when(include == "no" & pvalue == "p < 0.05" ~ 0.025,
                             TRUE ~ as.numeric(zcurve_pvalue))) 

# Combine both sets of p-values
combined_pvalues <- c(
  s_imprecise_pvalues$zcurve_pvalue,
  pvalues # included in primary z-curve analysis
)

# Conduct zcurve analysis
sensitivity_2 <- zcurve(p = combined_pvalues)
plot(sensitivity_2, CI = TRUE, annotation = TRUE, main = NULL)
```

### Sensitivity analysis 3

We conduct a $z$-curve analysis replacing $p$-values reported as $p$ \> 0.05 for $p$ = 0.05

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

# Select studies that reported p as "p > 0.05" and were not included in the z-curve analysis
ns_imprecise_pvalues <- zcurve_data %>%
  filter(include == "no" & pvalue == "p > 0.05") %>%
  select(include, pvalue, zcurve_pvalue)

# Convert "p > 0.05" to 0.5
ns_imprecise_pvalues <- ns_imprecise_pvalues %>%
  mutate(zcurve_pvalue = case_when(include == "no" & pvalue == "p > 0.05" ~ 0.05,
                             TRUE ~ as.numeric(zcurve_pvalue))) 

# Combine both sets of p-values
combined_pvalues <- c(
  ns_imprecise_pvalues$zcurve_pvalue,
  pvalues # included in primary z-curve analysis
)

# Conduct zcurve analysis
sensitivity_3 <- zcurve(p = combined_pvalues)
plot(sensitivity_3, CI = TRUE, annotation = TRUE, main = NULL)
```

### Sensitivity analysis 4

We conduct a $z$-curve analysis replacing $p$-values reported as $p$ \> 0.05 for $p$ = 0.25 and replacing $p$-values reported as $p$ \< 0.05 for 0.05

```{r}
#| echo: false
#| warning: false
#| fig-height: 6
#| fig-width: 6

# Combine both sets of p-values
combined_pvalues <- c(
  s_imprecise_pvalues$zcurve_pvalue,
  ns_imprecise_pvalues$zcurve_pvalue,
  pvalues
)

# Conduct zcurve analysis
sensitivity_4 <- zcurve(p = combined_pvalues)
plot(sensitivity_4, CI = TRUE, annotation = TRUE, main = NULL)
```
