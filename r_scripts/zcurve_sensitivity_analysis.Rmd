---
title: "Secondary z-curve analysis"
output:
  word_document: default
  html_document: default
date: "2026-01-04"
---

```{r}
#| echo: false
#| message: false

# load packages
library(here)
library(readxl)
library(dplyr)
library(kableExtra)
library(zcurve)
```


```{r}
#| echo: false
# load data
zcurve_data <- read_xlsx("../data/zcurve_data.xlsx", sheet = "Sheet1")
```


```{r}
#| echo: false
# Select p-values to be included in the z-curve analysis
pvalues <- zcurve_data %>%
  filter(include == "yes" & !is.na(zcurve_pvalue)) %>%
  select(zcurve_pvalue) %>%
  pull() %>%
  as.numeric()
```

# Secondary z-curve analyses

## Sensitivity analysis 1

We conducted a z-curve analysis excluding p-values that could be not recomputed when reported as "p \< 0.001", "p \< 0.005" and "p \< 0.003" but were imputed as p = 0.0001 and 0.0005 in the primary z-curve.

```{r}
#| echo: false

sensitivity_1 <- zcurve_data %>%
  filter(include == "yes" & !is.na(zcurve_pvalue)) %>%
  filter(!reason_exclusion %in% c("p < 0.001", 
                                  "p < 0.005",
                                  "p < 0.003")) %>%
  select(zcurve_pvalue) %>%
  pull() %>%
  as.numeric()

sensitivity_1 <- zcurve(p = sensitivity_1)
sensitivity_1_results <- summary(sensitivity_1, all = TRUE) 
sensitivity_1_results
```

Plot the results:

```{r}
#| echo: false
#| fig-height: 6
#| fig-width: 6
plot(sensitivity_1, CI = TRUE, annotation = TRUE, main = NULL)
```

## Sensitivity analysis 2

We conducted a z-curve analysis replacing p-values reported as p < 0.05 for p < 0.25

```{r}
#| echo: false

# Select studies that reported p as "p < 0.05" and were not included in the z-curve analysis
s_imprecise_pvalues <- zcurve_data %>%
  filter(include == "no" & pvalue == "p < 0.05") %>%
  select(include, pvalue, zcurve_pvalue)

# Convert "p < 0.05" to 0.25
s_imprecise_pvalues <- s_imprecise_pvalues %>%
  mutate(zcurve_pvalue = case_when(include == "no" & pvalue == "p < 0.05" ~ 0.25,
                             TRUE ~ as.numeric(zcurve_pvalue))) 

# Combine both sets of p-values
combined_pvalues <- c(
  s_imprecise_pvalues$zcurve_pvalue,
  pvalues # included in primary z-curve analysis
)

# Conduct zcurve analysis
sensitivity_2 <- zcurve(p = combined_pvalues)

sensitivity_2_results <- summary(sensitivity_2, all = TRUE)
sensitivity_2_results
```

Plot the results:

```{r}
#| echo: false
#| fig-height: 6
#| fig-width: 6

plot(sensitivity_2, CI = TRUE, annotation = TRUE, main = NULL)
```

## Sensitivity analysis 3

Conduct a z-curve analysis replacing p-values reported as p > 0.05 for p = 0.25

```{r}
#| echo: false

# Select studies that reported p as "p > 0.05" and were not included in the z-curve analysis
ns_imprecise_pvalues <- zcurve_data %>%
  filter(include == "no" & pvalue == "p > 0.05") %>%
  select(include, pvalue, zcurve_pvalue)

# Convert "p > 0.05" to 0.5
ns_imprecise_pvalues <- ns_imprecise_pvalues %>%
  mutate(zcurve_pvalue = case_when(include == "no" & pvalue == "p > 0.05" ~ 0.05,
                             TRUE ~ as.numeric(zcurve_pvalue))) 

# Combine both sets of p-values
combined_pvalues <- c(
  ns_imprecise_pvalues$zcurve_pvalue,
  pvalues # included in primary z-curve analysis
)

# Conduct zcurve analysis
sensitivity_3 <- zcurve(p = combined_pvalues)

sensitivity_3_results <- summary(sensitivity_3, all = TRUE)
sensitivity_3_results
```

Plot the results:

```{r}
#| echo: false
#| fig-height: 6
#| fig-width: 6

plot(sensitivity_3, CI = TRUE, annotation = TRUE, main = NULL)
```

## Sensitivity analysis 4

Conduct a z-curve analysis replacing p-values reported as p > 0.05 for p = 0.25 and replacing p-values reported as p < 0.05 for 0.05

```{r}
#| echo: false

# Combine both sets of p-values
combined_pvalues <- c(
  s_imprecise_pvalues$zcurve_pvalue,
  ns_imprecise_pvalues$zcurve_pvalue,
  pvalues
)

# Conduct zcurve analysis
sensitivity_4 <- zcurve(p = combined_pvalues)

sensitivity_4_results <- summary(sensitivity_4, all = TRUE)
sensitivity_4_results
```

Plot the results:

```{r}
#| echo: false
#| fig-height: 6
#| fig-width: 6

plot(sensitivity_4, CI = TRUE, annotation = TRUE, main = NULL)
```